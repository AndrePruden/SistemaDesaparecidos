<div class="awareness-stats-container">
   <div class="loading-stats" *ngIf="isLoadingStats">
      <p>Cargando estadísticas...</p>
   </div>

   <div class="awareness-stats" *ngIf="!isLoadingStats && totalReportesActivos > 0">
    <h3>Estadísticas del Problema</h3>
    <ul>
      <li>
          Actualmente hay <strong>{{ totalReportesActivos }}</strong> reporte{{ totalReportesActivos !== 1 ? 's' : '' }} activo{{ totalReportesActivos !== 1 ? 's' : '' }} de personas desaparecidas registrado{{ totalReportesActivos !== 1 ? 's' : '' }}.
           <span *ngIf="nombresReportesActivos.length > 0">
              Esto incluye a: <strong>{{ nombresReportesActivos.join(', ') }}</strong>.
          </span>
           <span *ngIf="nombresReportesActivos.length === 0 && totalReportesActivos > maxNombresToList">
           </span>
      </li>
      <li *ngIf="reportesUltimaSemanaActivos > 0">Se report{{ reportesUltimaSemanaActivos !== 1 ? 'aron' : 'ó' }} <strong>{{ reportesUltimaSemanaActivos }}</strong> nueva{{ reportesUltimaSemanaActivos !== 1 ? 's' : '' }} desaparici{{ reportesUltimaSemanaActivos !== 1 ? 'ones' : 'ón' }} en los últimos 7 días con estado activo.</li>
      <li *ngIf="reportesUltimaSemanaActivos === 0 && totalReportesActivos > 0">No se registraron nuevas desapariciones en los últimos 7 días con estado activo.</li>

        <li *ngIf="minEdadActivos !== null">
           El rango de edades de los reportes activos es de
           <ng-container *ngIf="minEdadActivos === maxEdadActivos">
               <strong>{{ minEdadActivos }} año{{ minEdadActivos !== 1 ? 's' : '' }}</strong>.
           </ng-container>
           <ng-container *ngIf="minEdadActivos !== maxEdadActivos">
               <strong>{{ minEdadActivos }} a {{ maxEdadActivos }} años</strong>.
           </ng-container>
       </li>
        <li *ngIf="totalReportesActivos > 0 && minEdadActivos === null">
           No se encontró información de edad para los reportes activos.
       </li>


      <li *ngIf="zonasMasReportesActivos.length > 0">Las {{ zonasMasReportesActivos.length }} zona{{ zonasMasReportesActivos.length !== 1 ? 's' : '' }} con más reporte{{ zonasMasReportesActivos.length !== 1 ? 's' : '' }} activo{{ zonasMasReportesActivos.length !== 1 ? 's' : '' }} {{ zonasMasReportesActivos.length !== 1 ? 'son' : 'es' }}:
          <span *ngFor="let zona of zonasMasReportesActivos; let last = last">
              <strong>{{ zona.lugar }}</strong> ({{ zona.count }} caso{{ zona.count !== 1 ? 's' : '' }}){{ !last ? '' : '.' }}{{ !last ? ', ' : '' }}
          </span>
      </li>
       <ng-container *ngIf="zonasMasReportesActivos.length < 3 && totalReportesActivos > 0">
            <li *ngIf="zonasMasReportesActivos.length === 0">Aún no hay suficientes reportes activos para identificar zonas predominantes.</li>
             <li *ngIf="zonasMasReportesActivos.length > 0 && zonasMasReportesActivos.length < 3">Hay menos de 3 zonas con reportes activos para mostrar un top 3 completo.</li>
       </ng-container>
         <li *ngIf="zonasMasReportesActivos.length >= 3 && totalReportesActivos > 0 && zonasMasReportesActivos[0].count === zonasMasReportesActivos[1].count && zonasMasReportesActivos[1].count === zonasMasReportesActivos[2].count">
              (Hay empate en el número de reportes en las 3 zonas principales)
         </li>
    </ul>
       <p class="context-note">Estadísticas basadas únicamente en los reportes con estado "Activo".</p>
  </div>

   <div class="awareness-stats no-stats-available" *ngIf="!isLoadingStats && totalReportesActivos === 0">
    <p>No hay reportes activos registrados en este momento para mostrar estadísticas. ¡Esperamos que esta cifra se mantenga!</p>
  </div>
</div>

<div class="contenedor-filtro">
  <input type="text" [(ngModel)]="nombreBusqueda" placeholder="Nombre..." (input)="filtrarReportes()">
  <input type="number" [(ngModel)]="edadBusqueda" placeholder="Edad..." (input)="filtrarReportes()">
  <input type="text" [(ngModel)]="lugarBusqueda" placeholder="Lugar de desaparición..." (input)="filtrarReportes()">
  <input type="date" [max]="fechaMaxima" [(ngModel)]="fechaBusqueda" (input)="filtrarReportes()" id="fecha">
  
  <select [(ngModel)]="autorFiltro" (change)="filtrarReportes()">
    <option value="todos">Todos los reportes</option>
    <option value="mios">Mis reportes</option>
  </select>
  <select [(ngModel)]="estadoFiltro" (change)="filtrarReportes()">
    <option value="activos">Activos</option>
    <option value="archivados">Archivados</option>
  </select>
  
  <button class="btn-limpiar" (click)="limpiarFiltros()">Limpiar filtros</button>
</div>

<div class="lista-reportes">
  <ng-container *ngIf="reportesFiltrados.length > 0; else noReportes">
    <div class="contenedor-cards">
      <div *ngFor="let reporte of reportesFiltrados" class="card-reporte">
        <img
          class="imagen-reporte"
          [src]="reporte.imagen"
          (error)="onImageError($event)"
          alt="Foto del reportado"
        />

        <div class="info-reporte">
          <h3>{{ reporte.nombre }}</h3>
          <p><strong>Edad:</strong> {{ reporte.edad }}</p>
          <p><strong>Fecha desaparición:</strong> {{ reporte.fechaDesaparicion | date:'mediumDate' }}</p>
          <p class="descripcion-recortada"><strong>Lugar:</strong> {{ reporte.lugarDesaparicionLegible }}</p>
          <p class="descripcion-recortada"><strong>Descripción:</strong> {{ reporte.descripcion || 'No hay descripción disponible' }}</p>
        </div>

        <div class="card-actions">
          <button class="btn-popup" (click)="mostrarPopup(reporte)">
            <i class="fas fa-map-marked-alt"></i> 
          </button>

          <button 
            (click)="archivarReporte(reporte.idDesaparecido)"
            [disabled]="!puedeArchivar(reporte)"
            [ngClass]="{ 'btn-desactivado': !puedeArchivar(reporte), 'btn-activo': puedeArchivar(reporte) }"
            class="btn-archivar"
          >Archivar
          </button>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-template #noReportes>
    <div class="mensaje-vacio">
      <img src="https://cdn-icons-png.flaticon.com/512/7486/7486898.png" alt="Sin resultados" class="icono-vacio">
      <p>No se encontraron reportes con los datos ingresados.</p>
      <button class="btn-refrescar" (click)="obtenerReportes()">
        <i class="fas fa-sync-alt"></i> Recargar reportes
      </button>
    </div>
  </ng-template>
</div>

<div *ngIf="reporteSeleccionado" class="popup">
  <div class="popup-content">
    <div class="popup-left">
      <h3>{{ reporteSeleccionado.nombre }}</h3>
      <p><strong>Edad:</strong> {{ reporteSeleccionado.edad }}</p>
      <p><strong>Desaparecido desde:</strong> {{ reporteSeleccionado.fechaDesaparicion | date:'mediumDate' }}</p>
      <p><strong>Lugar de desaparición:</strong> {{ reporteSeleccionado.lugarDesaparicionLegible }}</p>
      <p><strong>Descripción:</strong> {{ reporteSeleccionado.descripcion || 'No hay descripción disponible' }}</p>
      
      <div *ngIf="reporteSeleccionado.ultimoAvistamiento" class="ultimo-avistamiento">
        <h4><i class="fas fa-binoculars"></i> Último Avistamiento</h4>
        <p><strong>Fecha:</strong> {{ reporteSeleccionado.ultimoAvistamiento.fecha | date:'medium' }}</p>
        <p class="descripcion"><strong>Detalles:</strong> {{ reporteSeleccionado.ultimoAvistamiento.descripcion || 'No hay detalles adicionales' }}</p>
      </div>
      <div *ngIf="!reporteSeleccionado.ultimoAvistamiento" class="sin-avistamientos">
        <p><i class="fas fa-info-circle"></i> No hay avistamientos registrados</p>
      </div>
    </div>
    
    <div class="popup-right">
      <div class="mapa-popup" 
           [id]="'mapaPopup-' + reporteSeleccionado.idDesaparecido"
           style="border: 2px solid #ff5722; min-height: 300px;">
        <div *ngIf="!mapas['mapaPopup-' + reporteSeleccionado.idDesaparecido]" 
             style="padding: 20px; background: #ffebee;">
          <ul>
            <li>Leaflet no se cargó correctamente</li>
            <li>Coordenadas inválidas: {{ reporteSeleccionado.lugarDesaparicion }}</li>
            <li>Error en la inicialización (ver consola F12)</li>
          </ul>
        </div>
      </div>

      <div class="mapa-leyenda">
        <div class="leyenda-item">
          <span class="leyenda-color rojo"></span>
          <span>Lugar de desaparición</span>
        </div>
        <div class="leyenda-item" *ngIf="reporteSeleccionado.ultimoAvistamiento">
          <span class="leyenda-color azul"></span>
          <span>Último avistamiento</span>
        </div>
      </div>
    </div>
  </div>
  <button class="cerrar-btn" (click)="cerrarPopup()">✕</button>
</div>
